<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=../12.3/ rel=prev><link href=../12.5/ rel=next><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.2, mkdocs-material-9.0.6"><title>12.4 备份和恢复 - A golang ebook intro how to build a web with golang</title><link rel=stylesheet href=../assets/stylesheets/main.558e4712.min.css><link rel=stylesheet href=../assets/stylesheets/palette.2505c338.min.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary data-md-color-accent> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#124 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=.. title="A golang ebook intro how to build a web with golang" class="md-header__button md-logo" aria-label="A golang ebook intro how to build a web with golang" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> A golang ebook intro how to build a web with golang </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 12.4 备份和恢复 </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/itboon/golang-web-dev title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> itboon/golang-web-dev </div> </a> </div> </nav> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class="md-tabs__link md-tabs__link--active"> 简体中文 </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="A golang ebook intro how to build a web with golang" class="md-nav__button md-logo" aria-label="A golang ebook intro how to build a web with golang" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> A golang ebook intro how to build a web with golang </label> <div class=md-nav__source> <a href=https://github.com/itboon/golang-web-dev title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> itboon/golang-web-dev </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " data-md-toggle=__nav_1 type=checkbox id=__nav_1 checked> <label class=md-nav__link for=__nav_1 tabindex=0 aria-expanded=true> 简体中文 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=简体中文 data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> 简体中文 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> 目录 </a> </li> <li class=md-nav__item> <a href=../01.0/ class=md-nav__link> 1 GO环境配置 </a> </li> <li class=md-nav__item> <a href=../01.1/ class=md-nav__link> 1.1安装 Go </a> </li> <li class=md-nav__item> <a href=../01.2/ class=md-nav__link> 1.2 Go Module, GOPATH 与工作空间 </a> </li> <li class=md-nav__item> <a href=../01.3/ class=md-nav__link> 1.3 Go 命令 </a> </li> <li class=md-nav__item> <a href=../01.4/ class=md-nav__link> 1.4 Go开发工具 </a> </li> <li class=md-nav__item> <a href=../01.5/ class=md-nav__link> 1.5 总结 </a> </li> <li class=md-nav__item> <a href=../02.0/ class=md-nav__link> 2 Go语言基础 </a> </li> <li class=md-nav__item> <a href=../02.1/ class=md-nav__link> 2.1 你好 Go </a> </li> <li class=md-nav__item> <a href=../02.2/ class=md-nav__link> 2.2 Go基础 </a> </li> <li class=md-nav__item> <a href=../02.3/ class=md-nav__link> 2.3 流程和函数 </a> </li> <li class=md-nav__item> <a href=../02.4/ class=md-nav__link> 2.4 struct类型 </a> </li> <li class=md-nav__item> <a href=../02.5/ class=md-nav__link> 2.5 面向对象 </a> </li> <li class=md-nav__item> <a href=../02.6/ class=md-nav__link> 2.6 interface </a> </li> <li class=md-nav__item> <a href=../02.7/ class=md-nav__link> 2.7 并发 </a> </li> <li class=md-nav__item> <a href=../02.8/ class=md-nav__link> 2.8 总结 </a> </li> <li class=md-nav__item> <a href=../03.0/ class=md-nav__link> 3 Web基础 </a> </li> <li class=md-nav__item> <a href=../03.1/ class=md-nav__link> 3.1 Web工作方式 </a> </li> <li class=md-nav__item> <a href=../03.2/ class=md-nav__link> 3.2 Go搭建一个Web服务器 </a> </li> <li class=md-nav__item> <a href=../03.3/ class=md-nav__link> 3.3 Go如何使得Web工作 </a> </li> <li class=md-nav__item> <a href=../03.4/ class=md-nav__link> 3.4 Go的http包详解 </a> </li> <li class=md-nav__item> <a href=../03.5/ class=md-nav__link> 3.5 小结 </a> </li> <li class=md-nav__item> <a href=../04.0/ class=md-nav__link> 4 表单 </a> </li> <li class=md-nav__item> <a href=../04.1/ class=md-nav__link> 4.1 处理表单的输入 </a> </li> <li class=md-nav__item> <a href=../04.2/ class=md-nav__link> 4.2 验证表单的输入 </a> </li> <li class=md-nav__item> <a href=../04.3/ class=md-nav__link> 4.3 预防跨站脚本 </a> </li> <li class=md-nav__item> <a href=../04.4/ class=md-nav__link> 4.4 防止多次递交表单 </a> </li> <li class=md-nav__item> <a href=../04.5/ class=md-nav__link> 4.5 处理文件上传 </a> </li> <li class=md-nav__item> <a href=../04.6/ class=md-nav__link> 4.6 小结 </a> </li> <li class=md-nav__item> <a href=../05.0/ class=md-nav__link> 5 访问数据库 </a> </li> <li class=md-nav__item> <a href=../05.1/ class=md-nav__link> 5.1 database/sql接口 </a> </li> <li class=md-nav__item> <a href=../05.2/ class=md-nav__link> 5.2 使用MySQL数据库 </a> </li> <li class=md-nav__item> <a href=../05.3/ class=md-nav__link> 5.3 使用SQLite数据库 </a> </li> <li class=md-nav__item> <a href=../05.4/ class=md-nav__link> 5.4 使用PostgreSQL数据库 </a> </li> <li class=md-nav__item> <a href=../05.5/ class=md-nav__link> 5.5 使用Beego orm库进行ORM开发 </a> </li> <li class=md-nav__item> <a href=../05.6/ class=md-nav__link> 5.6 NOSQL数据库操作 </a> </li> <li class=md-nav__item> <a href=../05.7/ class=md-nav__link> 5.7 小结 </a> </li> <li class=md-nav__item> <a href=../06.0/ class=md-nav__link> 6 session和数据存储 </a> </li> <li class=md-nav__item> <a href=../06.1/ class=md-nav__link> 6.1 session和cookie </a> </li> <li class=md-nav__item> <a href=../06.2/ class=md-nav__link> 6.2 Go如何使用session </a> </li> <li class=md-nav__item> <a href=../06.3/ class=md-nav__link> 6.3 session存储 </a> </li> <li class=md-nav__item> <a href=../06.4/ class=md-nav__link> 6.4 预防session劫持 </a> </li> <li class=md-nav__item> <a href=../06.5/ class=md-nav__link> 6.5 小结 </a> </li> <li class=md-nav__item> <a href=../07.0/ class=md-nav__link> 7 文本处理 </a> </li> <li class=md-nav__item> <a href=../07.1/ class=md-nav__link> 7.1 XML处理 </a> </li> <li class=md-nav__item> <a href=../07.2/ class=md-nav__link> 7.2 JSON处理 </a> </li> <li class=md-nav__item> <a href=../07.3/ class=md-nav__link> 7.3 正则处理 </a> </li> <li class=md-nav__item> <a href=../07.4/ class=md-nav__link> 7.4 模板处理 </a> </li> <li class=md-nav__item> <a href=../07.5/ class=md-nav__link> 7.5 文件操作 </a> </li> <li class=md-nav__item> <a href=../07.6/ class=md-nav__link> 7.6 字符串处理 </a> </li> <li class=md-nav__item> <a href=../07.7/ class=md-nav__link> 7.7 小结 </a> </li> <li class=md-nav__item> <a href=../08.0/ class=md-nav__link> 8 Web服务 </a> </li> <li class=md-nav__item> <a href=../08.1/ class=md-nav__link> 8.1 Socket编程 </a> </li> <li class=md-nav__item> <a href=../08.2/ class=md-nav__link> 8.2 WebSocket </a> </li> <li class=md-nav__item> <a href=../08.3/ class=md-nav__link> 8.3 REST </a> </li> <li class=md-nav__item> <a href=../08.4/ class=md-nav__link> 8.4 RPC </a> </li> <li class=md-nav__item> <a href=../08.5/ class=md-nav__link> 8.5 小结 </a> </li> <li class=md-nav__item> <a href=../09.0/ class=md-nav__link> 9 安全与加密 </a> </li> <li class=md-nav__item> <a href=../09.1/ class=md-nav__link> 9.1 预防CSRF攻击 </a> </li> <li class=md-nav__item> <a href=../09.2/ class=md-nav__link> 9.2 确保输入过滤 </a> </li> <li class=md-nav__item> <a href=../09.3/ class=md-nav__link> 9.3 避免XSS攻击 </a> </li> <li class=md-nav__item> <a href=../09.4/ class=md-nav__link> 9.4 避免SQL注入 </a> </li> <li class=md-nav__item> <a href=../09.5/ class=md-nav__link> 9.5 存储密码 </a> </li> <li class=md-nav__item> <a href=../09.6/ class=md-nav__link> 9.6 加密和解密数据 </a> </li> <li class=md-nav__item> <a href=../09.7/ class=md-nav__link> 9.7 小结 </a> </li> <li class=md-nav__item> <a href=../10.0/ class=md-nav__link> 10 国际化和本地化 </a> </li> <li class=md-nav__item> <a href=../10.1/ class=md-nav__link> 10.1 设置默认地区 </a> </li> <li class=md-nav__item> <a href=../10.2/ class=md-nav__link> 10.2 本地化资源 </a> </li> <li class=md-nav__item> <a href=../10.3/ class=md-nav__link> 10.3 国际化站点 </a> </li> <li class=md-nav__item> <a href=../10.4/ class=md-nav__link> 10.4 小结 </a> </li> <li class=md-nav__item> <a href=../11.0/ class=md-nav__link> 11 错误处理，调试和测试 </a> </li> <li class=md-nav__item> <a href=../11.1/ class=md-nav__link> 11.1 错误处理 </a> </li> <li class=md-nav__item> <a href=../11.2/ class=md-nav__link> 11.2 使用GDB调试 </a> </li> <li class=md-nav__item> <a href=../11.3/ class=md-nav__link> 11.3 Go怎么写测试用例 </a> </li> <li class=md-nav__item> <a href=../11.4/ class=md-nav__link> 11.4 小结 </a> </li> <li class=md-nav__item> <a href=../12.0/ class=md-nav__link> 12 部署与维护 </a> </li> <li class=md-nav__item> <a href=../12.1/ class=md-nav__link> 12.1 应用日志 </a> </li> <li class=md-nav__item> <a href=../12.2/ class=md-nav__link> 12.2 网站错误处理 </a> </li> <li class=md-nav__item> <a href=../12.3/ class=md-nav__link> 12.3 应用部署 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 12.4 备份和恢复 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> 12.4 备份和恢复 </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 应用备份 </a> <nav class=md-nav aria-label=应用备份> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rsync class=md-nav__link> rsync安装 </a> </li> <li class=md-nav__item> <a href=#rsync_1 class=md-nav__link> rsync配置 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#mysql class=md-nav__link> MySQL备份 </a> </li> <li class=md-nav__item> <a href=#mysql_1 class=md-nav__link> MySQL恢复 </a> </li> <li class=md-nav__item> <a href=#redis class=md-nav__link> redis备份 </a> </li> <li class=md-nav__item> <a href=#redis_1 class=md-nav__link> redis恢复 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 小结 </a> </li> <li class=md-nav__item> <a href=#links class=md-nav__link> links </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../12.5/ class=md-nav__link> 12.5 小结 </a> </li> <li class=md-nav__item> <a href=../13.0/ class=md-nav__link> 13 如何设计一个Web框架 </a> </li> <li class=md-nav__item> <a href=../13.1/ class=md-nav__link> 13.1 项目规划 </a> </li> <li class=md-nav__item> <a href=../13.2/ class=md-nav__link> 13.2 自定义路由器设计 </a> </li> <li class=md-nav__item> <a href=../13.3/ class=md-nav__link> 13.3 controller设计 </a> </li> <li class=md-nav__item> <a href=../13.4/ class=md-nav__link> 13.4 日志和配置设计 </a> </li> <li class=md-nav__item> <a href=../13.5/ class=md-nav__link> 13.5 实现博客的增删改 </a> </li> <li class=md-nav__item> <a href=../13.6/ class=md-nav__link> 13.6 小结 </a> </li> <li class=md-nav__item> <a href=../14.0/ class=md-nav__link> 14 扩展Web框架 </a> </li> <li class=md-nav__item> <a href=../14.1/ class=md-nav__link> 14.1 静态文件支持 </a> </li> <li class=md-nav__item> <a href=../14.2/ class=md-nav__link> 14.2 Session支持 </a> </li> <li class=md-nav__item> <a href=../14.3/ class=md-nav__link> 14.3 表单及验证支持 </a> </li> <li class=md-nav__item> <a href=../14.4/ class=md-nav__link> 14.4 用户认证 </a> </li> <li class=md-nav__item> <a href=../14.5/ class=md-nav__link> 14.5 多语言支持 </a> </li> <li class=md-nav__item> <a href=../14.6/ class=md-nav__link> 14.6 pprof支持 </a> </li> <li class=md-nav__item> <a href=../14.7/ class=md-nav__link> 14.7 小结 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 应用备份 </a> <nav class=md-nav aria-label=应用备份> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rsync class=md-nav__link> rsync安装 </a> </li> <li class=md-nav__item> <a href=#rsync_1 class=md-nav__link> rsync配置 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#mysql class=md-nav__link> MySQL备份 </a> </li> <li class=md-nav__item> <a href=#mysql_1 class=md-nav__link> MySQL恢复 </a> </li> <li class=md-nav__item> <a href=#redis class=md-nav__link> redis备份 </a> </li> <li class=md-nav__item> <a href=#redis_1 class=md-nav__link> redis恢复 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 小结 </a> </li> <li class=md-nav__item> <a href=#links class=md-nav__link> links </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=124>12.4 备份和恢复<a class=headerlink href=#124 title="Permanent link"> ¶</a></h1> <p>这小节我们要讨论应用程序管理的另一个方面：生产服务器上数据的备份和恢复。我们经常会遇到生产服务器的网络断了、硬盘坏了、操作系统崩溃、或者数据库不可用了等各种异常情况，所以维护人员需要对生产服务器上的应用和数据做好异地灾备，冷备热备的准备。在接下来的介绍中，讲解了如何备份应用、如何备份/恢复Mysql数据库和redis数据库。</p> <h2 id=_1>应用备份<a class=headerlink href=#_1 title="Permanent link"> ¶</a></h2> <p>在大多数集群环境下，Web应用程序基本不需要备份，因为这个其实就是一个代码副本，我们在本地开发环境中，或者版本控制系统中已经保持这些代码。但是很多时候，一些开发的站点需要用户来上传文件，那么我们需要对这些用户上传的文件进行备份。目前其实有一种合适的做法就是把和网站相关的需要存储的文件存储到云储存，这样即使系统崩溃，只要我们的文件还在云存储上，至少数据不会丢失。</p> <p>如果我们没有采用云储存的情况下，如何做到网站的备份呢？这里我们介绍一个文件同步工具rsync：rsync能够实现网站的备份，不同系统的文件的同步，如果是windows的话，需要windows版本cwrsync。</p> <h3 id=rsync>rsync安装<a class=headerlink href=#rsync title="Permanent link"> ¶</a></h3> <p>rysnc的官方网站：http://rsync.samba.org/ 可以从上面获取最新版本的源码。当然，因为rsync是一款非常有用的软件，所以很多Linux的发行版本都将它收录在内了。</p> <p>软件包安装</p> <div class=highlight><pre><span></span><code># sudo apt-get  install  rsync  注：在debian、ubuntu 等在线安装方法；
# yum install rsync    注：Fedora、Redhat、CentOS 等在线安装方法；
# rpm -ivh rsync       注：Fedora、Redhat、CentOS 等rpm包安装方法；
</code></pre></div> <p>其它Linux发行版，请用相应的软件包管理方法来安装。源码包安装</p> <div class=highlight><pre><span></span><code>tar xvf  rsync-xxx.tar.gz
cd rsync-xxx
./configure --prefix=/usr  ;make ;make install   注：在用源码包编译安装之前，您得安装gcc等编译工具才行；
</code></pre></div> <h3 id=rsync_1>rsync配置<a class=headerlink href=#rsync_1 title="Permanent link"> ¶</a></h3> <p>rsync主要有以下三个配置文件rsyncd.conf(主配置文件)、rsyncd.secrets(密码文件)、rsyncd.motd(rysnc服务器信息)。</p> <p>关于这几个文件的配置大家可以参考官方网站或者其他介绍rsync的网站，下面介绍服务器端和客户端如何开启</p> <ul> <li> <p>服务端开启：</p> <div class=highlight><pre><span></span><code>#/usr/bin/rsync --daemon  --config=/etc/rsyncd.conf
</code></pre></div> <p>--daemon参数方式，是让rsync以服务器模式运行。把rsync加入开机启动</p> <div class=highlight><pre><span></span><code>echo &#39;rsync --daemon&#39; &gt;&gt; /etc/rc.d/rc.local
</code></pre></div> <p>设置rsync密码</p> <div class=highlight><pre><span></span><code>echo &#39;你的用户名:你的密码&#39; &gt; /etc/rsyncd.secrets
chmod 600 /etc/rsyncd.secrets
</code></pre></div> </li> <li> <p>客户端同步：</p> <p>客户端可以通过如下命令同步服务器上的文件：</p> <div class=highlight><pre><span></span><code>rsync -avzP  --delete  --password-file=rsyncd.secrets   用户名@192.168.145.5::www /var/rsync/backup
</code></pre></div> <p>这条命令，简要的说明一下几个要点：</p> <ol> <li>-avzP是啥，读者可以使用--help查看</li> <li>--delete 是为了比如A上删除了一个文件，同步的时候，B会自动删除相对应的文件</li> <li>--password-file 客户端中/etc/rsyncd.secrets设置的密码，要和服务端的 /etc/rsyncd.secrets 中的密码一样，这样cron运行的时候，就不需要密码了</li> <li>这条命令中的"用户名"为服务端的 /etc/rsyncd.secrets中的用户名</li> <li>这条命令中的 192.168.145.5 为服务端的IP地址</li> <li>::www，注意是2个 : 号，www为服务端的配置文件 /etc/rsyncd.conf 中的[www]，意思是根据服务端上的/etc/rsyncd.conf来同步其中的[www]段内容，一个 : 号的时候，用于不根据配置文件，直接同步指定目录。</li> </ol> <p>为了让同步实时性，可以设置crontab，保持rsync每分钟同步，当然用户也可以根据文件的重要程度设置不同的同步频率。</p> </li> </ul> <h2 id=mysql>MySQL备份<a class=headerlink href=#mysql title="Permanent link"> ¶</a></h2> <p>应用数据库目前还是MySQL为主流，目前MySQL的备份有两种方式：热备份和冷备份，热备份目前主要是采用master/slave方式（master/slave方式的同步目前主要用于数据库读写分离，也可以用于热备份数据），关于如何配置这方面的资料，大家可以找到很多。冷备份的话就是数据有一定的延迟，但是可以保证该时间段之前的数据完整，例如有些时候可能我们的误操作引起了数据的丢失，那么master/slave模式是无法找回丢失数据的，但是通过冷备份可以部分恢复数据。</p> <p>冷备份一般使用shell脚本来实现定时备份数据库，然后通过上面介绍rsync同步非本地机房的一台服务器。</p> <p>下面这个是定时备份mysql的备份脚本，我们使用了mysqldump程序，这个命令可以把数据库导出到一个文件中。</p> <div class=highlight><pre><span></span><code>#!/bin/bash

# 以下配置信息请自己修改
mysql_user=&quot;USER&quot; #MySQL备份用户
mysql_password=&quot;PASSWORD&quot; #MySQL备份用户的密码
mysql_host=&quot;localhost&quot;
mysql_port=&quot;3306&quot;
mysql_charset=&quot;utf8&quot; #MySQL编码
backup_db_arr=(&quot;db1&quot; &quot;db2&quot;) #要备份的数据库名称，多个用空格分开隔开 如(&quot;db1&quot; &quot;db2&quot; &quot;db3&quot;)
backup_location=/var/www/mysql  #备份数据存放位置，末尾请不要带&quot;/&quot;,此项可以保持默认，程序会自动创建文件夹
expire_backup_delete=&quot;ON&quot; #是否开启过期备份删除 ON为开启 OFF为关闭
expire_days=3 #过期时间天数 默认为三天，此项只有在expire_backup_delete开启时有效

# 本行开始以下不需要修改
backup_time=`date +%Y%m%d%H%M`  #定义备份详细时间
backup_Ymd=`date +%Y-%m-%d` #定义备份目录中的年月日时间
backup_3ago=`date -d &#39;3 days ago&#39; +%Y-%m-%d` #3天之前的日期
backup_dir=$backup_location/$backup_Ymd  #备份文件夹全路径
welcome_msg=&quot;Welcome to use MySQL backup tools!&quot; #欢迎语

# 判断MYSQL是否启动,mysql没有启动则备份退出
mysql_ps=`ps -ef |grep mysql |wc -l`
mysql_listen=`netstat -an |grep LISTEN |grep $mysql_port|wc -l`
if [ [$mysql_ps == 0] -o [$mysql_listen == 0] ]; then
        echo &quot;ERROR:MySQL is not running! backup stop!&quot;
        exit
else
        echo $welcome_msg
fi

# 连接到mysql数据库，无法连接则备份退出
mysql -h$mysql_host -P$mysql_port -u$mysql_user -p$mysql_password &lt;&lt;end
use mysql;
select host,user from user where user=&#39;root&#39; and host=&#39;localhost&#39;;
exit
end

flag=`echo $?`
if [ $flag != &quot;0&quot; ]; then
        echo &quot;ERROR:Can&#39;t connect mysql server! backup stop!&quot;
        exit
else
        echo &quot;MySQL connect ok! Please wait......&quot;
        # 判断有没有定义备份的数据库，如果定义则开始备份，否则退出备份
        if [ &quot;$backup_db_arr&quot; != &quot;&quot; ];then
                #dbnames=$(cut -d &#39;,&#39; -f1-5 $backup_database)
                #echo &quot;arr is (${backup_db_arr[@]})&quot;
                for dbname in ${backup_db_arr[@]}
                do
                        echo &quot;database $dbname backup start...&quot;
                        `mkdir -p $backup_dir`
                        `mysqldump -h$mysql_host -P$mysql_port -u$mysql_user -p$mysql_password $dbname --default-character-set=$mysql_charset | gzip &gt; $backup_dir/$dbname-$backup_time.sql.gz`
                        flag=`echo $?`
                        if [ $flag == &quot;0&quot; ];then
                                echo &quot;database $dbname success backup to $backup_dir/$dbname-$backup_time.sql.gz&quot;
                        else
                                echo &quot;database $dbname backup fail!&quot;
                        fi

                done
        else
                echo &quot;ERROR:No database to backup! backup stop&quot;
                exit
        fi
        # 如果开启了删除过期备份，则进行删除操作
        if [ &quot;$expire_backup_delete&quot; == &quot;ON&quot; -a  &quot;$backup_location&quot; != &quot;&quot; ];then
                 #`find $backup_location/ -type d -o -type f -ctime +$expire_days -exec rm -rf {} \;`
                 `find $backup_location/ -type d -mtime +$expire_days | xargs rm -rf`
                 echo &quot;Expired backup data delete complete!&quot;
        fi
        echo &quot;All database backup success! Thank you!&quot;
        exit
fi
</code></pre></div> <p>修改shell脚本的属性：</p> <div class=highlight><pre><span></span><code>chmod 600 /root/mysql_backup.sh
chmod +x /root/mysql_backup.sh
</code></pre></div> <p>设置好属性之后，把命令加入crontab，我们设置了每天00:00定时自动备份，然后把备份的脚本目录/var/www/mysql设置为rsync同步目录。</p> <div class=highlight><pre><span></span><code>00 00 * * * /root/mysql_backup.sh
</code></pre></div> <h2 id=mysql_1>MySQL恢复<a class=headerlink href=#mysql_1 title="Permanent link"> ¶</a></h2> <p>前面介绍MySQL备份分为热备份和冷备份，热备份主要的目的是为了能够实时的恢复，例如应用服务器出现了硬盘故障，那么我们可以通过修改配置文件把数据库的读取和写入改成slave，这样就可以尽量少时间的中断服务。</p> <p>但是有时候我们需要通过冷备份的SQL来进行数据恢复，既然有了数据库的备份，就可以通过命令导入：</p> <div class=highlight><pre><span></span><code>mysql -u username -p databse &lt; backup.sql
</code></pre></div> <p>可以看到，导出和导入数据库数据都是相当简单，不过如果还需要管理权限，或者其他的一些字符集的设置的话，可能会稍微复杂一些，但是这些都是可以通过一些命令来完成的。</p> <h2 id=redis>redis备份<a class=headerlink href=#redis title="Permanent link"> ¶</a></h2> <p>redis是目前我们使用最多的NoSQL，它的备份也分为两种：热备份和冷备份，redis也支持master/slave模式，所以我们的热备份可以通过这种方式实现，相应的配置大家可以参考官方的文档配置，相当的简单。我们这里介绍冷备份的方式：redis其实会定时的把内存里面的缓存数据保存到数据库文件里面，我们备份只要备份相应的文件就可以，就是利用前面介绍的rsync备份到非本地机房就可以实现。</p> <h2 id=redis_1>redis恢复<a class=headerlink href=#redis_1 title="Permanent link"> ¶</a></h2> <p>redis的恢复分为热备份恢复和冷备份恢复，热备份恢复的目的和方法同MySQL的恢复一样，只要修改应用的相应的数据库连接即可。</p> <p>但是有时候我们需要根据冷备份来恢复数据，redis的冷备份恢复其实就是只要把保存的数据库文件copy到redis的工作目录，然后启动redis就可以了，redis在启动的时候会自动加载数据库文件到内存中，启动的速度根据数据库的文件大小来决定。</p> <h2 id=_2>小结<a class=headerlink href=#_2 title="Permanent link"> ¶</a></h2> <p>本小节介绍了我们的应用部分的备份和恢复，即如何做好灾备，包括文件的备份、数据库的备份。同时也介绍了使用rsync同步不同系统的文件，MySQL数据库和redis数据库的备份和恢复，希望通过本小节的介绍，能够给作为开发的你对于线上产品的灾备方案提供一个参考方案。 </p> <h2 id=links>links<a class=headerlink href=#links title="Permanent link"> ¶</a></h2> <ul> <li><a href=../preface/ >目录</a></li> <li>上一章: <a href=../12.3/ >应用部署</a></li> <li>下一节: <a href=../12.5/ >小结</a></li> </ul> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.code.annotate", "content.code.copy", "navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.sections"], "search": "../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../assets/javascripts/bundle.51d95adb.min.js></script> </body> </html>